	<div class="step externalService-step panel panel-rvdstep">
		<div class="panel-heading"><h4 class="panel-title"><i ng-click='step.isCollapsed = !step.isCollapsed' class="fa rvd-clickable" ng-class="{'fa-caret-right': step.isCollapsed, 'fa-caret-down': !step.isCollapsed}"></i>&nbsp; &nbsp;<span  tooltip='{{step.name}}'>{{step.title}}</span> <em><small ng-show='step.isCollapsed'>{{step.phrase}}</small></em><i ng-click='stepService.removeStep(steps,stepnames,step,orderedSteps)' class='fa fa-trash-o pull-right rvd-clickable'></i></h4></div>
		<div class="panel-body" ng-hide='step.isCollapsed'>
			<div class="row">
				<div class="col-md-12">
				
                    <div class="service-url-wrap">
                        <div class="input-group input-group-sm form-group">
                            <span class="input-group-addon help-tooltip" tooltip='Specify the extrernal service URL. Avoid passing query parameters directly and use "Add URL parameter" button below.' tooltip-trigger='mouseenter' tooltip-popup-delay='1000'>Service Url</span>
                            <input name="url" class="form-control ng-pristine ng-valid ng-valid-pattern" type="url" placeholder="http://" ng-model='step.url' required></input>
                        </div>
                        <!--<div class="validation-error"  ng-show="form.digits.$invalid">Invalid digit value</div> -->
                        
                        <div class='row'>
                            <div ng-repeat='urlParam in step.urlParams' class="col-md-4">
                                <div  class="input-group input-group-sm form-group">
                                    <span class="input-group-addon">Name</span>
                                    <input ng-model='urlParam.name' class="form-control ng-pristine ng-valid ng-valid-pattern" type="text" required></input>
                                    <span class="input-group-addon">Value</span>
                                    <input ng-model='urlParam.value' class="form-control ng-pristine ng-valid ng-valid-pattern" type="text" required></input>
                                    <span ng-click='removeUrlParam(step,urlParam)' class="input-group-addon fa fa-times rvd-clickable"></span>
                                </div>
                            </div>
                        </div>
                        <button ng-click="addUrlParam(step)" type="button" class="btn btn-xs"><span>Add URL parameter</span></button>  &nbsp; <i class="fa fa-info-circle rvd-clickable" popover="Add a name-value query parameter. Use '$variable' values to pass RVD variables" popover-placement='top'></i>
                     </div>
                        
					<h4>Assign response to variables <i ng-click='step.iface.helpCollapsed = !step.iface.helpCollapsed' class="fa fa-info-circle rvd-clickable"></i></h4>
                    <div collapse="!step.iface.helpCollapsed">
                        <div class="well">
                            <p>Assign JSON response fields to RVD variables to access the data returned from RVD components. Create an assignment for each separate piece of information you need.</p>
                            <p>For each assignment:</p>
                            <ul>
                                <li>Fill in the "Assign to" field with the name of the RVD variable you want to create.</li>
                                <li>Click "Add operation" to add one or more access operations until you drill down to the JSON member variable you need. For objects use the 'propertyNamed' action to access a specific property. For arrays use the 'itemAtPosition' action to access the N'th array element.</li>
                                <li>The last operation should be 'string'. Don't forget to press 'Done' when done.</li>
                                <li>Undo your mistakes with the circular arrow button.</li>
                            </ul>
                            <p>
                                All variables variables created this way will be available for use in this module (or the next if a routing decision is made).
                            </p>
                            <div class="wellinfo-rollup"><i ng-click='step.iface.helpCollapsed = !step.iface.helpCollapsed' class="fa fa-angle-double-up rvd-clickable"></i></div>
                         </div> 
                    </div>

					<div class="form-group">
						<button ng-click="addAssignment(step)" type="button" class="btn btn-primary btn-xs"><span>Add assignment</span></button>
					</div>

					
					<div ng-repeat="assignment in step.assignments" class="assignment form-group">
						<div class="row">
							<div class="col-md-3">
								<div class="input-group input-group-sm form-group">
									<span class="input-group-addon">Assign to</span>
									<input ng-model='assignment.destVariable' type="text" class="form-control" placeholder='type variable name' required></input>
								</div>
							</div>
							
							<div class="col-md-8">
								<form name="form{{$index}}" novalidate>
									<div class="input-group input-group-sm form-group">
										<span class="input-group-addon">{{assignmentExpression(assignment)}}</span>
										
										<select ng-show='assignment.lastOperation != null' ng-change='assignment.lastOperation.action=""' ng-model='assignment.lastOperation.kind' ng-options='operationKind as operationKind for operationKind in accessOperationKinds' class="form-control input-sm" required></select>

										<span ng-if='assignment.lastOperation.kind=="object"' class="input-group-addon"></span>
										<select ng-if='assignment.lastOperation.kind=="object"' ng-change='assignment.lastOperation.property=""' ng-model='assignment.lastOperation.action' ng-options='objectAction as objectAction for objectAction in objectActions' class="form-control input-sm" required></select>
										<span ng-if='assignment.lastOperation.action=="propertyNamed"' class="input-group-addon"></span>
										<input ng-if='assignment.lastOperation.action=="propertyNamed"' name='property'  ng-model='assignment.lastOperation.property' placeholder='type the object property to access' class="form-control" required></input>

										<span ng-if='assignment.lastOperation.kind=="array"' class="input-group-addon"></span>
										<select ng-if='assignment.lastOperation.kind=="array"' ng-change='assignment.lastOperation.position=""'  ng-model='assignment.lastOperation.action' ng-options='arrayAction as arrayAction for arrayAction in arrayActions' class="form-control input-sm" required></select>
										<span ng-if='assignment.lastOperation.action=="itemAtPosition"' class="input-group-addon"></span>
										<input ng-if='assignment.lastOperation.action=="itemAtPosition"' type='number' name='position' ng-model='assignment.lastOperation.position' placeholder='type array item index'  class="form-control" required></input>
																				
									</div>
									<!-- <div class="validation-error" ng-show="form{{$index}}.property.$error.required">property required</div>
									<div class="validation-error" ng-show="form{{$index}}.position.$error.required">item position required</div>
									-->
									<button ng-show='!accessOperationProtos[assignment.lastOperation.kind].terminal' ng-disabled='form{{$index}}.$invalid' ng-click="addOperation(assignment)" type="button" class="btn btn-primary btn-xs pull-right"><span>Add operation</span></button>
									<button ng-show='accessOperationProtos[assignment.lastOperation.kind].terminal' ng-click="doneAddingOperations(assignment)" type="button" class="btn btn-primary btn-xs pull-right"><span>Done</span></button>
									<button ng-show='assignment.accessOperations.length > 0' ng-click='popOperation(assignment)' type='button' class="btn btn-xs pull-right"><i  class="fa fa-undo" ></i></button>


								</form>
							</div>
							<div class="col-md-1">
								<span ng-click='removeAssignment(step,assignment)' class="fa fa-times text-muted remove-button rvd-clickable"></span>
							</div>
						</div>
					</div>
					

				
					<h4>Make a routing decision <i ng-click='step.iface.routingHelpCollapsed = !step.iface.routingHelpCollapsed' class="fa fa-info-circle rvd-clickable"></i></h4>
                    <div collapse="!step.iface.routingHelpCollapsed">
                        <div class="well">
                            <p>Check "Continue to" checkbox below to change call flow after the external service has responded:</p>
                            <ul>
                                <li>Select 'variable' to use one of the variables created by the assignments above to determine which module comes next. The variable should contain the next module's label (the label of the module tab).</li>
                                <li>Select 'fixed' to use a hardcoded module setting.</li>
                                <li>Leave "Continue to" to unchecked to if you don't want to change the call flow at this point.</li>
                            </ul>
                            <div class="wellinfo-rollup"><i ng-click='step.iface.routingHelpCollapsed = !step.iface.routingHelpCollapsed' class="fa fa-angle-double-up rvd-clickable"></i></div>
                         </div> 
                    </div>		
                    			
					<div class="row">
						<div class="col-md-12">
                            <div class="input-group input-group-sm routing-decision-controls">
                                <span class="input-group-addon">
									<input ng-model='step.doRouting' type="checkbox">
								</span>
                                
								<span ng-class="{'text-muted': !step.doRouting}"  ng-model='step.next' class="input-group-addon">Continue to</span>
								<span ng-if='step.doRouting' class="input-group-addon">
									<span>fixed &nbsp;</span>
									<input ng-model='step.nextType' value='fixed' type="radio">
								</span>
								<span ng-if='step.doRouting' class="input-group-addon">
									<span>variable &nbsp;</span>
									<input ng-model='step.nextType' value='variable' type="radio">
								</span>								
								<select ng-if='step.doRouting && step.nextType=="variable"' ng-model='step.nextVariable' ng-options='assignment.destVariable as assignment.destVariable for assignment in step.assignments' class="form-control height-fix" required></select>
								<select sync-model ng-if='step.doRouting && step.nextType=="fixed"'  ng-model='step.next' ng-options='target.name as target.label for target in getAllTargets()' class="form-control height-fix" required>
												<option value=""></option>
								</select>
                                
								<!-- this is just a placeholder -->
								<input ng-hide='step.doRouting' ng-disabled='true' class="form-control height-fix">
							</div>
														
						</div>
					</div>
					
				
				</div>
			</div>
					
		</div>
	</div>
