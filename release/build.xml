<?xml version="1.0"?>
<project name="telscale.restcomm.release" default="release" basedir=".">
	<property environment="sys"/>
    	<property name="release.dir" location="${ant.file.telscale.restcomm.release}/../target" />
	<property name="release.tomcat.dir" location="${ant.file.telscale.restcomm.release}/../target-tomcat" />
	<property name="release.hsqldb.dir" location="${ant.file.telscale.restcomm.release}/../target-hsqldb" />
        <property name="release.as7.dir" location="${ant.file.telscale.restcomm.release}/../target-as7" />
	<property name="base.dir" location="${ant.file.telscale.restcomm.release}/.." />
	<property name="docs.dir" location="${release.dir}/docs" />
	<property name="restcomm.docs.dir" location="${release.dir}/docs/restcomm" />
	<property name="restcomm.docs.tomcat.dir" location="${release.tomcat.dir}/docs/restcomm" />
        <property name="restcomm.docs.as7.dir" location="${release.as7.dir}/docs/restcomm" />
	<property name="checkout.dir" value="${base.dir}/checkout" />	
	<property name="checkout.telscale-restcomm.dir" value="${checkout.dir}/telscale-restcomm/restcomm" />
	<property name="checkout.hsqldb.dir" value="${checkout.dir}/hsqldb" />
	<property name="telscale.restcomm.release.version" value="6.1.1-TelScale-SNAPSHOT"/>
	<property name="telscale.restcomm.branch.name" value="ts11"/>
	
	<!--Telscale binaries versions-->
	<property name="telscale-sipservlets.version" value="6.1.3.GA" />
        <property name="telscale-sipservlets-as7.version" value="7.0.0.GA" />
	<property name="telscale-media.version" value="6.1.2.GA" />
	<property name="telscale-lb.version" value="6.1.2.GA" />
	<property name="telscale-diameter.version" value="6.1.2.GA" />
	
	
	<!--GET Telscale-Sip=Servlets & Telscale-Media-Server & Telscale Diameter - properties-->
	<property name="telscale-sipservlets.distro.version" value="${telscale-sipservlets.version}-jboss-as-5.1.0.GA-1306131642" />
	<property name="telscale-sipservlets.download.distro.file" value="TelScale-SIP-Servlets-${telscale-sipservlets.distro.version}.zip" />
	<property name="telscale-sipservlets.download.url" value="ftp://ftp.box.com/TelScale%20SIP%20Servlets/6.1.3.GA/${telscale-sipservlets.download.distro.file}" />
	<property name="telscale-sipservlets.distro.zip.path" value="${checkout.dir}/${telscale-sipservlets.download.distro.file}" />

	<property name="telscale-sipservlets.tomcat.distro.version" value="${telscale-sipservlets.version}-apache-tomcat-6.0.35-1306171557" />
	<property name="telscale-sipservlets.tomcat.download.distro.file" value="TelScale-SIP-Servlets-${telscale-sipservlets.tomcat.distro.version}.zip" />
	<property name="telscale-sipservlets.tomcat.download.url" value="ftp://ftp.box.com/TelScale%20SIP%20Servlets/6.1.3.GA/${telscale-sipservlets.tomcat.download.distro.file}" />
	<property name="telscale-sipservlets.tomcat.distro.zip.path" value="${checkout.dir}/${telscale-sipservlets.tomcat.download.distro.file}" />

        <property name="telscale-sipservlets.as7.distro.version" value="${telscale-sipservlets-as7.version}-jboss-as-7.1.3.Final-1308082200" />
        <property name="telscale-sipservlets.as7.download.distro.file" value="TelScale-SIP-Servlets-${telscale-sipservlets.as7.distro.version}.zip" />
        <property name="telscale-sipservlets.as7.download.url" value="ftp://ftp.box.com/TelScale%20SIP%20Servlets/7.0.0.GA/TelScale-SIP-Servlets-7.0.0.GA-jboss-as-7.1.3.Final-1308082200.zip" />
        <property name="telscale-sipservlets.as7.distro.zip.path" value="${checkout.dir}/${telscale-sipservlets.as7.download.distro.file}" />

	<property name="hsqldb.download.url" value="http://downloads.sourceforge.net/project/hsqldb/hsqldb/hsqldb_1_8_0/hsqldb_1_8_0_10.zip" />
	<property name="hsqldb.download.distro.file" value="hsqldb_1_8_0_10.zip" />
	<property name="hsqldb.distro.zip.path" value="${checkout.dir}/${hsqldb.download.distro.file}" />


	<property name="telscale-sipservlets-nolce.distro.version" value="${telscale-sipservlets.version}-jboss-as-5.1.0.GA_no-lce-1306131642" />
	<property name="telscale-sipservlets-nolce.download.distro.file" value="TelScale-SIP-Servlets-${telscale-sipservlets-nolce.distro.version}.zip" />
	<property name="telscale-sipservlets-nolce.download.url" value="ftp://ftp.box.com/TelScale%20SIP%20Servlets/6.1.3.GA/no-lce/${telscale-sipservlets-nolce.download.distro.file}" />
	<property name="telscale-sipservlets-nolce.distro.zip.path" value="${checkout.dir}/${telscale-sipservlets-nolce.download.distro.file}" />
	
	<property name="telscale-media.download.distro.file" value="TelScale-media-${telscale-media.version}.zip" />
	<property name="telscale-media.download.url" value="ftp://ftp.box.com/TelScale%20media/${telscale-media.version}/${telscale-media.download.distro.file}" />
	<property name="telscale-media.distro.zip.path" value="${checkout.dir}/${telscale-media.download.distro.file}" />
	
	<property name="telscale-diameter.download.distro.file" value="TelScale-diameter-${telscale-diameter.version}.zip" />
	<property name="telscale-diameter.download.url" value="ftp://ftp.box.com/TelScale%20jDiameter/${telscale-diameter.version}/${telscale-diameter.download.distro.file}" />
	<property name="telscale-diameter.distro.zip.path" value="${checkout.dir}/${telscale-diameter.download.distro.file}" />

	<property name="release.build.goals" value="clean install -DskipTests=true"/>
	<property name="release.build.test.goals" value="clean install"/>
	<property name="release.ts.deploy.goals" value="clean deploy"/>
	
	

	<condition property="mvn.executable" value="${sys.M2_HOME}\bin\mvn.bat" else="mvn">
		<os family="windows"/>
	</condition>
	
	<taskdef onerror="fail" resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${ant.file.mobicents.restcomm.release}/../ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	
	<target name="release" depends="clean,get-deps,extract-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	<target name="release-for-ami" depends="clean,get-ami-deps,extract-ami-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	<target name="release-for-ami-no-clean" depends="get-ami-deps,extract-ami-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	<target name="release-no-clean" depends="get-deps,extract-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	
    <target name="deploy">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release">
    		<property name="release.build.goals" value="${release.ts.deploy.goals}" />
    	</ant>
    </target>
	
    <target name="deploy-no-clean">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release-no-clean">
    		<property name="release.build.goals" value="${release.ts.deploy.goals}" />
    	</ant>
    </target>
	
    <target name="release-test">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release">
    		<property name="release.build.goals" value="${release.build.test.goals}" />
    	</ant>
    </target>
	
    <target name="release-test-no-clean">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release-no-clean">
    		<property name="release.build.goals" value="${release.build.test.goals}" />
    	</ant>
    </target>

	
	
	<!--GET Telscale-Sip=Servlets & Telscale-Media-Server & Telscale Diameter - downloads-->
	
	<target name="get-deps" depends="get-telscale-sipservlets,get-telscale-sipservlets-tomcat,get-telscale-sipservlets-as7,get-telscale-media,get-telscale-diameter" />
	<target name="get-ami-deps" depends="get-ami-telscale-sipservlets,get-telscale-media,get-telscale-diameter" />
	<target name="extract-deps" depends="extract-telscale-sipservlets,extract-telscale-sipservlets-tomcat,extract-telscale-sipservlets-as7,extract-telscale-media,extract-telscale-diameter" />
	<target name="extract-ami-deps" depends="extract-ami-telscale-sipservlets,extract-telscale-media,extract-telscale-diameter" />
	
	<!--SipServlets JBoss-->
	<available file="${telscale-sipservlets.distro.zip.path}" property="got.telscale-sipservlets" />
	<target name="get-telscale-sipservlets" unless="got.telscale-sipservlets">
		<echo>Downloading Telscale SipServlets version: ${telscale-sipservlets.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-sipservlets.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-sipservlets.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<!--SipServlets Tomcat-->
	<available file="${hsql.distro.zip.path}" property="got.hsqldb-tomcat" />
	<target name="get-hsqldb-tomcat" unless="got.hsqldb-tomcat">
		<echo>Downloading HSQLDB Driver for Tomcat version: ${telscale-sipservlets.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="${hsqldb.download.url}" />
		</exec>
		<move file="${base.dir}/${hsqldb.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<available file="${telscale-sipservlets.tomcat.distro.zip.path}" property="got.telscale-sipservlets-tomcat" />
	<target name="get-telscale-sipservlets-tomcat" unless="got.telscale-sipservlets-tomcat">
		<echo>Downloading Telscale SipServlets Tomcat version: ${telscale-sipservlets.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-sipservlets.tomcat.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-sipservlets.tomcat.download.distro.file}" todir="${checkout.dir}"/>
	</target>

        <!--SipServlets JBoss AS7 -->
        <available file="${telscale-sipservlets.as7.distro.zip.path}" property="got.telscale-sipservlets-as7" />
        <target name="get-telscale-sipservlets-as7" unless="got.telscale-sipservlets-as7">
                <echo>Downloading Telscale SipServlets JBoss AS7 version: ${telscale-sipservlets-as7.version}</echo>
                <exec failonerror="true" executable="wget">
                    <arg value="--user=telscale-file-server@telestax.com" />
                    <arg value="--password=t31sca13fi13s" />
                    <arg value="${telscale-sipservlets.as7.download.url}" />
                </exec>
                <move file="${base.dir}/${telscale-sipservlets.as7.download.distro.file}" todir="${checkout.dir}"/>
        </target>
	
	<!--SipServlets with no LCE-->
	<available file="${telscale-sipservlets-nolce.distro.zip.path}" property="got.telscale-sipservlets-nolce" />
	<target name="get-ami-telscale-sipservlets" unless="got.telscale-sipservlets-nolce">
		<echo>Downloading Telscale SipServlets (with no LCE) version: ${telscale-sipservlets.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-sipservlets-nolce.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-sipservlets-nolce.download.distro.file}" todir="${checkout.dir}"/>
	</target>
	

	<target name="extract-telscale-sipservlets" depends="get-telscale-sipservlets">
		<delete dir="${checkout.telscale-sipservlets.dir}" failonerror="false" />
		<unzip src="${telscale-sipservlets.distro.zip.path}" dest="${release.dir}">
			<mapper type="glob" from="TelScale-SIP-Servlets-${telscale-sipservlets.version}-jboss-as-5.1.0.GA/*" to="*"/>
		</unzip>
	</target>
	
	<target name="extract-telscale-sipservlets-tomcat" depends="get-telscale-sipservlets-tomcat,extract-hsqldb">
		<delete dir="${checkout.telscale-sipservlets-tomcat.dir}" failonerror="false" />
		<unzip src="${telscale-sipservlets.tomcat.distro.zip.path}" dest="${release.tomcat.dir}">
			<mapper type="glob" from="TelScale-SIP-Servlets-${telscale-sipservlets.version}-apache-tomcat-6.0.35/*" to="*"/>
		</unzip>
	</target>

        <target name="extract-telscale-sipservlets-as7" depends="get-telscale-sipservlets-as7,extract-hsqldb">
                <delete dir="${checkout.telscale-sipservlets-as7.dir}" failonerror="false" />
                <unzip src="${telscale-sipservlets.as7.distro.zip.path}" dest="${release.as7.dir}">
                        <mapper type="glob" from="TelScale-SIP-Servlets-${telscale-sipservlets-as7.version}-jboss-as-7.1.3.Final/*" to="*"/>
                </unzip>
        </target>

	<target name="extract-hsqldb" depends="get-hsqldb-tomcat">
		<delete dir="${checkout.hsqldb.dir}" failonerror="false" />
		<unzip src="${hsqldb.distro.zip.path}" dest="${release.hsqldb.dir}"/>
	</target>

	<target name="extract-ami-telscale-sipservlets" depends="get-ami-telscale-sipservlets,extract-hsqldb">
		<delete dir="${checkout.telscale-sipservlets.dir}" failonerror="false" />
		<unzip src="${telscale-sipservlets-nolce.distro.zip.path}" dest="${release.dir}">
			<mapper type="glob" from="TelScale-SIP-Servlets-${telscale-sipservlets.version}-jboss-as-5.1.0.GA/*" to="*"/>
		</unzip>
	</target>
	
	
	<!--Media-->
	<available file="${telscale-media.distro.zip.path}" property="got.telscale-media" />
	<target name="get-telscale-media" unless="got.telscale-media">
		<echo>Downloading Telscale Slee version: ${telscale-media.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-media.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-media.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<target name="extract-telscale-media" depends="get-telscale-media">
		<delete dir="${checkout.telscale-media.dir}" failonerror="false" />
		<unzip src="${telscale-media.distro.zip.path}" dest="${release.dir}/telscale-media"/>
		<unzip src="${telscale-media.distro.zip.path}" dest="${release.tomcat.dir}/telscale-media"/>
	</target>
	
	<!--diameter-->
	<available file="${telscale-diameter.distro.zip.path}" property="got.telscale-diameter" />
	<target name="get-telscale-diameter" unless="got.telscale-diameter">
		<echo>Downloading Telscale Slee version: ${telscale-diameter.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-diameter.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-diameter.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<target name="extract-telscale-diameter" depends="get-telscale-diameter">
		<delete dir="${checkout.telscale-diameter.dir}" failonerror="false" />
		<unzip src="${telscale-diameter.distro.zip.path}" dest="${release.dir}/telscale-diameter"/>
	</target>
	
	
    <target name="checkout-restcomm">
        <echo>Checking out restcomm</echo>
        <exec failonerror="true" executable="git">
            <arg value="clone" />
            <arg value="-b" />
            <arg value="${telscale.restcomm.branch.name}" />
            <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-restcomm.git" />
            <arg value="${checkout.telscale-restcomm.dir}" />
        </exec>
    </target>
	
	<target name="build-telscale-restcomm">
        <echo>Building Telscale Restcomm</echo>
        <exec failonerror="true" executable="${mvn.executable}" dir="${checkout.telscale-restcomm.dir}">
                <arg line="${release.build.goals}" />
        </exec>
        <exec failonerror="true" executable="${mvn.executable}" dir="${checkout.telscale-restcomm.dir}/restcomm.docs">
                <arg line="${release.build.goals} -Ptelscale" />
        </exec>
	</target>

    <target name="copy-restcomm">
        <echo>Copy restcomm </echo>
		<!--default-->
	<copy tofile="${release.dir}/server/default/conf/dars/mobicents-dar.properties" failonerror="true" 
        	file="${basedir}/mobicents-dar.properties"/>
        <!--copy tofile="${release.dir}/server/default/deploy/restcomm.war" failonerror="true" 
        	file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war"/-->
	<!-- https://bitbucket.org/telestax/telscale-restcomm/issue/55/restcommwar-is-compressed-which-doesnt -->
        <copy todir="${release.dir}/server/default/deploy/restcomm.war" failonerror="true">
                <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm">
                        <include name="**/*" />
                </fileset>
        </copy>
		<!--all-->
	<copy tofile="${release.dir}/server/all/conf/dars/mobicents-dar.properties" failonerror="true" 
        	file="${basedir}/mobicents-dar.properties"/>
        <!--copy tofile="${release.dir}/server/all/deploy/restcomm.war" failonerror="true" 
        	file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war"/-->
	<!-- https://bitbucket.org/telestax/telscale-restcomm/issue/55/restcommwar-is-compressed-which-doesnt -->
        <copy todir="${release.dir}/server/all/deploy/restcomm.war" failonerror="true">
                <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm">
                        <include name="**/*" />
                </fileset>
        </copy>
		<!--tomcat-->
	<copy tofile="${release.tomcat.dir}/bin/catalina.sh" failonerror="true" 
        	file="${basedir}/catalina.sh"/>
	<copy tofile="${release.tomcat.dir}/conf/dars/mobicents-dar.properties" failonerror="true" 
        	file="${basedir}/mobicents-dar.properties"/>
	<!--copy tofile="${release.tomcat.dir}/webapps/restcomm.war" failonerror="true" 
        	file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war"/-->
	<!-- https://bitbucket.org/telestax/telscale-restcomm/issue/55/restcommwar-is-compressed-which-doesnt -->
	<copy todir="${release.tomcat.dir}/webapps/restcomm" failonerror="true">
                <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm">
                        <include name="**/*" />
                </fileset>
        </copy>
	<copy tofile="${release.tomcat.dir}/lib/hsqldb.jar" failonerror="true" 
        	file="${release.hsqldb.dir}/hsqldb/lib/hsqldb.jar"/>
        <copy file="${basedir}/telestax-license.xml" todir="${release.tomcat.dir}" failonerror="true" />

        <!--JBoss AS7-->
        <copy tofile="${release.as7.dir}/standalone/configuration/dars/mobicents-dar.properties" failonerror="true" 
                file="${basedir}/mobicents-dar.properties"/>
        <copy todir="${release.as7.dir}/standalone/deployments" failonerror="true"
		file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war" />
        <zip destfile="${release.as7.dir}/standalone/deployments/restcomm.war" update="true">
		<zipfileset dir="${release.hsqldb.dir}/hsqldb/lib" includes="hsqldb.jar" prefix="WEB-INF/lib/"/>
	</zip>
        <copy file="${basedir}/telestax-license.xml" todir="${release.as7.dir}" failonerror="true" />
    	
    </target>
	
    <target name="copy-docs">
		<!--docs-->
	    <mkdir dir="${restcomm.docs.dir}"/>
		<copy todir="${restcomm.docs.dir}" failonerror="true">
		        <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.docs/jdocbook-telscale/target/docbook/publish/en-US">
		                <include name="**/*" />
		        </fileset>
		</copy>
		<!--docs tomcat-->
		<mkdir dir="${restcomm.docs.tomcat.dir}"/>
		<copy todir="${restcomm.docs.tomcat.dir}" failonerror="true">
		        <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.docs/jdocbook-telscale/target/docbook/publish/en-US">
		                <include name="**/*" />
		        </fileset>
		</copy>
                <!--docs JBoss AS7-->
                <mkdir dir="${restcomm.docs.as7.dir}"/>
                <copy todir="${restcomm.docs.as7.dir}" failonerror="true">
                        <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.docs/jdocbook-telscale/target/docbook/publish/en-US">
                                <include name="**/*" />
                        </fileset>
                </copy>
    </target>
	
	
	<target name="make-final-zip" depends="set-time-stamp">
		<zip destfile="${base.dir}/TelScale-Restcomm-JBoss-${telscale.restcomm.release.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${release.dir}" prefix="TelScale-Restcomm-JBoss-${telscale.restcomm.release.version}">
				<include name="**" />
			</zipfileset>
		</zip>
		<fixcrlf srcdir="${release.tomcat.dir}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.dir}/TelScale-Restcomm-Tomcat-${telscale.restcomm.release.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${release.tomcat.dir}/bin" filemode="755" prefix="TelScale-Restcomm-Tomcat-${telscale.restcomm.release.version}/bin">
                                <include name="*.sh" />
                        </zipfileset>
			<zipfileset dir="${release.tomcat.dir}/bin" prefix="TelScale-Restcomm-Tomcat-${telscale.restcomm.release.version}/bin">
                                <include name="*.sh" />
                        </zipfileset>
			<zipfileset dir="${release.tomcat.dir}" prefix="TelScale-Restcomm-Tomcat-${telscale.restcomm.release.version}">
				<include name="**" />
			</zipfileset>
		</zip>
                <zip destfile="${base.dir}/TelScale-Restcomm-JBoss-AS7-${telscale.restcomm.release.version}-${time.stamp}.zip" filesonly="false">
                        <zipfileset dir="${release.as7.dir}" prefix="TelScale-Restcomm-JBoss-${telscale.restcomm.release.version}">
                                <include name="**" />
                        </zipfileset>
                </zip>
	</target>
	
	<target name="set-time-stamp" unless="skip.timestamp">
		<tstamp>
			<format property="time.stamp" pattern="yyMMddHHmm" />
		</tstamp>
	</target>
	
	<target name="clean">
	    <delete dir="${release.dir}"/>
	    <delete dir="${release.tomcat.dir}"/>
            <delete dir="${release.as7.dir}"/>
	    <delete dir="${release.hsqldb.dir}"/>
	    <delete dir="${checkout.telscale-restcomm.dir}"/>
	</target>
</project>
